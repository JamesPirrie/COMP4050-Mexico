{% extends 'base.html' %}

{% block title %}New Project - VivaMQ{% endblock %}

{% block content %}

<div class="newProjcontent">
    <div class="project-info">
        <div class="project-title">Project Information</div>
        <input type="text" class="editable-title" placeholder="Enter project title">
    </div>

    <div class="columns-container">
        <div class="column">
            <h3>Viva Questions</h3>
            <p>Write your own questions below</p>
            <textarea id="custom-questions" class="question-box" placeholder="Enter your questions here..."></textarea>
        </div>

        <div class="column">
            <h3>Use our AI Tool</h3>
            <p>Upload a document and generate some questions below.</p>

            <form id="upload-form" enctype="multipart/form-data"></form>
                <input type="file" id="pdf-upload" name="pdf_file" accept=".pdf" />
                <button type="submit" id="generate-btn">Generate/Regenerate</button>
            </form>

            <!-- <form method="post" enctype="multipart/form-data" class="upload-generate-container">
                <label class="upload-button">
                    <img src="{{ url_for('static', filename='icons/upload.png') }}" alt="Upload">
                    <input type="file" name="pdf_file" id="pdf_file" accept=".pdf">
                </label>
                <button type="submit" class="generate-button">Generate/Regenerate</button>
            </form> -->

            <div id="generated-questions" class="generated-questions"></div>
        </div>
    </div>

    <div class="button-container">
        <a href="{{ url_for('vivas') }}" class="cancel-button">Cancel</a>
        <button id="save-button" class="save-button">Save</button>
    </div>
</div>
</div>
</div>

<script>
    document.getElementById('upload-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var formData = new FormData(this);
        
        fetch('/new_project', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            var questionsContainer = document.getElementById('generated-questions');
            questionsContainer.innerHTML = '';
            
            if (data.error) {
                questionsContainer.innerHTML = `<p>Error: ${data.error}</p>`;
            } else {
                data.forEach((question, index) => {
                    questionsContainer.innerHTML += `<p>${index + 1}. ${question}</p>`;
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('generated-questions').innerHTML = '<p>An error occurred while generating questions.</p>';
        });
    });
    
    document.getElementById('save-button').addEventListener('click', function() {
        var projectTitle = document.getElementById('project-title').value;
        var customQuestions = document.getElementById('custom-questions').value;
        var generatedQuestions = document.getElementById('generated-questions').innerHTML;
        
        if (!projectTitle) {
            alert('Please enter a project title');
            return;
        }

        fetch('/save_project', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: projectTitle,
                customQuestions: customQuestions,
                generatedQuestions: generatedQuestions
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Project saved successfully!');
                window.location.href = "{{ url_for('vivas') }}";
            } else {
                alert('Failed to save project. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while saving the project.');
        });
    });
    </script>
{% endblock %}